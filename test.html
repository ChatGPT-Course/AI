<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админ-панель курса</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --orange: #FF9800;
      --yellow: #FFF9C4;
      --white: #FFF;
      --text: #222;
      --light-gray: #F5F7FA;
      --medium-gray: #E0E0E0;
      --dark-gray: #CCCCCC;
      --success: #4CAF50;
      --error: #F44336;
      --blue: #4285F4;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      --filter-bg: #f0f2f5;
    }
    
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--light-gray);
      color: var(--text);
      line-height: 1.5;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .header {
      margin-bottom: 20px;
      text-align: center;
    }
    
    h1 {
      color: var(--orange);
      margin: 0 0 20px 0;
      font-size: 24px;
      font-weight: 600;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
      max-width: 100%;
    }
    
    .search-input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid var(--medium-gray);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border 0.3s;
      box-sizing: border-box;
      max-width: 100%;
    }
    
    .search-input:focus {
      border-color: var(--orange);
    }
    
    .sort-btn {
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      border: 1px solid var(--medium-gray);
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      text-align: left;
      position: relative;
    }
    
    .sort-btn::after {
      content: "▼";
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
    }
    
    .sort-dropdown {
      position: absolute;
      background: var(--filter-bg);
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 10;
      width: 100%;
      display: none;
      margin-top: 5px;
      padding: 10px 0;
    }
    
    .sort-dropdown.show {
      display: block;
    }
    
    .sort-group-title {
      padding: 8px 15px;
      font-weight: 600;
      color: var(--orange);
      font-size: 13px;
      text-transform: uppercase;
    }
    
    .sort-option {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .sort-option:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    
    .sort-checkbox {
      width: 16px;
      height: 16px;
      border: 1px solid var(--medium-gray);
      border-radius: 3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .sort-checkbox.checked {
      background: var(--orange);
      border-color: var(--orange);
    }
    
    .sort-checkbox.checked::after {
      content: "✓";
      color: white;
      font-size: 12px;
    }
    
    .filter-actions {
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      border-top: 1px solid var(--medium-gray);
    }
    
    .filter-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }
    
    .filter-btn.reset {
      background: var(--medium-gray);
      color: var(--text);
    }
    
    .filter-btn.apply {
      background: var(--orange);
      color: white;
    }
    
    .divider {
      height: 1px;
      background: var(--medium-gray);
      margin: 10px 0;
    }
    
    .users-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .user-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: var(--shadow);
      position: relative;
      margin-bottom: 15px;
    }
    
    .user-name {
      font-weight: 500;
      margin: 0 0 4px 0;
      font-size: 15px;
      color: var(--text);
    }
    
    .user-username {
      color: #666;
      margin: 0;
      font-size: 14px;
    }
    
    .user-payment-status {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 500;
      font-size: 12px;
    }
    
    .user-payment-status.paid {
      background-color: var(--success);
      color: white;
    }
    
    .user-payment-status.unpaid {
      background-color: var(--error);
      color: white;
    }
    
    .settings-btn {
      position: absolute;
      right: 16px;
      top: 44px;
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      font-size: 18px;
    }
    
    .settings-btn:hover {
      color: var(--orange);
    }
    
  .user-progress {
    position: absolute;
    right: 44px; /* Сдвигаем влево от шестеренки */
    top: 44px; /* Выравниваем по вертикали с шестеренкой */
    color: var(--orange);
    font-weight: 500;
    font-size: 14px;
  }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      transform: translateY(-20px);
      transition: transform 0.3s;
    }
    
    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-title {
      margin: 0 0 20px 0;
      color: var(--text);
      font-size: 18px;
      font-weight: 500;
    }
    
    .modal-field {
      margin-bottom: 20px;
    }
    
    .modal-label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #666;
    }
    
    .modal-value {
      font-weight: 500;
      padding: 4px 0;
    }
    
    .payment-control {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .payment-label {
      font-weight: 500;
      font-size: 14px;
    }
    
    .payment-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .payment-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--success);
    }
    
    .progress-container {
      position: relative;
      margin: 25px 0 35px;
      height: 20px;
      display: flex;
      align-items: center;
    }
    
    .progress-line {
      position: absolute;
      width: 100%;
      height: 4px;
      background: var(--medium-gray);
      border-radius: 2px;
    }
    
    .progress-filled {
      position: absolute;
      height: 4px;
      background: var(--blue);
      border-radius: 2px;
      left: 0;
    }
    
    .progress-slider {
      width: 100%;
      margin: 0;
      -webkit-appearance: none;
      height: 20px;
      background: transparent;
      position: relative;
      z-index: 2;
    }
    
    .progress-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--blue);
      cursor: pointer;
      position: relative;
      z-index: 3;
    }
    
    .progress-marks {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      transform: translateY(-50%);
      z-index: 1;
    }
    
    .progress-mark {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--medium-gray);
      position: relative;
    }
    
    .progress-mark.active {
      background: var(--blue);
    }
    
    .progress-mark::after {
      content: attr(data-value);
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: #666;
    }
    
    .progress-mark.active::after {
      font-weight: bold;
      font-size: 14px;
      color: var(--blue);
    }
    
    .progress-hint {
      text-align: center;
      margin-top: 25px;
      font-size: 13px;
      color: #666;
      min-height: 20px;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }
    
    .modal-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    
    .modal-btn.save {
      background-color: var(--success);
      color: white;
    }
    
    .modal-btn.cancel {
      background-color: var(--medium-gray);
      color: var(--text);
    }
    
    .modal-btn:disabled {
      background-color: var(--medium-gray);
      color: var(--dark-gray);
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .access-denied {
      text-align: center;
      padding: 40px 20px;
      display: none;
    }
    
    .access-denied h2 {
      color: var(--error);
      margin-bottom: 16px;
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px 0;
    }
    
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--orange);
      animation: spin 1s linear infinite;
    }
    
    .hidden {
      display: none;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      left: 0;
      right: 0;
      margin: 0 auto;
      max-width: 400px;
      background: var(--success);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 1100;
      opacity: 0;
      transition: opacity 0.3s;
      text-align: center;
    }
    
    .notification.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="adminContent" class="hidden">
      <div class="header">
        <h1>Управление курсом</h1>
        <div class="controls">
          <input type="text" class="search-input" id="searchInput" placeholder="Поиск по имени или юзернейму...">
          
          <div style="position: relative;">
            <button class="sort-btn" id="sortBtn">Фильтр пользователей</button>
            <div class="sort-dropdown" id="sortDropdown">
              <div class="sort-group-title">Фильтр по оплате</div>
              <div class="sort-option" data-sort="paid">
                <span>Оплаченные</span>
                <div class="sort-checkbox" data-sort="paid"></div>
              </div>
              <div class="sort-option" data-sort="unpaid">
                <span>Неоплаченные</span>
                <div class="sort-checkbox" data-sort="unpaid"></div>
              </div>
              
              <div class="divider"></div>
              
              <div class="sort-group-title">Фильтр по прогрессу</div>
              <div class="sort-option" data-sort="progress-asc">
                <span>По возрастанию</span>
                <div class="sort-checkbox" data-sort="progress-asc"></div>
              </div>
              <div class="sort-option" data-sort="progress-desc">
                <span>По убыванию</span>
                <div class="sort-checkbox" data-sort="progress-desc"></div>
              </div>
              
              <div class="filter-actions">
                <button class="filter-btn reset" id="resetFilter">Сбросить</button>
                <button class="filter-btn apply" id="applyFilter">Применить</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="usersContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
    
    <div id="accessDenied" class="access-denied">
      <h2>Доступ запрещен</h2>
      <p>У вас нет прав для просмотра этой страницы.</p>
      <p id="accessErrorDetails" style="color: #888; font-size: 12px; margin-top: 10px;"></p>
    </div>
  </div>
  
  <div class="modal-overlay" id="settingsModal">
    <div class="modal-content">
      <h3 class="modal-title">Редактирование пользователя</h3>
      
      <div class="modal-field">
        <div class="modal-label">Имя</div>
        <div class="modal-value">Имя: <span id="modalUserName"></span></div>
      </div>
      
      <div class="modal-field">
        <div class="modal-label">Юзернейм</div>
        <div class="modal-value">Юзернейм: <span id="modalUserUsername"></span></div>
      </div>
      
      <div class="modal-field">
        <div class="modal-label">Оплата</div>
        <div class="payment-control">
          <div class="payment-label" id="paymentStatusText">Не оплачен</div>
          <div class="payment-checkbox">
            <span>Оплатить курс</span>
            <input type="checkbox" id="paymentCheckbox">
          </div>
        </div>
      </div>
      
      <div class="modal-field">
        <div class="modal-label">Прогресс</div>
        <div class="progress-container">
          <div class="progress-line"></div>
          <div class="progress-filled" id="progressFilled"></div>
          <input type="range" min="0" max="5" value="0" class="progress-slider" id="progressSlider" step="1">
          <div class="progress-marks" id="progressMarks"></div>
        </div>
        <div class="progress-hint" id="progressHint"></div>
      </div>
      
      <div class="modal-buttons">
        <button class="modal-btn cancel" id="modalCancelBtn">Отмена</button>
        <button class="modal-btn save" id="modalSaveBtn">Сохранить</button>
      </div>
    </div>
  </div>

  <div class="notification" id="notification">Настройки успешно сохранены</div>

  <script>
    // Конфигурация
    const config = {
      orgs: 'weamcfo6',
      projectName: 'p27jdsmk69wuimh',
      tableName: 'mc6qh91f060pv4y',
      apiToken: 'bocQfycJpJsTG_tbwEf8ma8E5rhoig0njMDXFWtJ',
      apiVersion: 'v1',
      allowedAdminIds: [1515638372] // Только ваш ID
    };
    
    // Элементы
    const adminContent = document.getElementById('adminContent');
    const accessDenied = document.getElementById('accessDenied');
    const accessErrorDetails = document.getElementById('accessErrorDetails');
    const usersContainer = document.getElementById('usersContainer');
    const searchInput = document.getElementById('searchInput');
    const sortBtn = document.getElementById('sortBtn');
    const sortDropdown = document.getElementById('sortDropdown');
    const resetFilter = document.getElementById('resetFilter');
    const applyFilter = document.getElementById('applyFilter');
    const settingsModal = document.getElementById('settingsModal');
    const modalUserName = document.getElementById('modalUserName');
    const modalUserUsername = document.getElementById('modalUserUsername');
    const paymentStatusText = document.getElementById('paymentStatusText');
    const paymentCheckbox = document.getElementById('paymentCheckbox');
    const progressSlider = document.getElementById('progressSlider');
    const progressFilled = document.getElementById('progressFilled');
    const progressMarks = document.getElementById('progressMarks');
    const progressHint = document.getElementById('progressHint');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    const notification = document.getElementById('notification');
    
    // Переменные состояния
    let allUsers = [];
    let filteredUsers = [];
    let currentUserTelegramId = null;
    let lastUpdateTime = 0;
    let currentSort = null;
    let refreshInterval = null;
    let currentEditingUserId = null;
    let currentEditingUserData = null;
    let isSaving = false;

    // Подсказки для прогресса
    const progressHints = [
      "Предстоит пройти вступление",
      "Пройдено вступление, предстоит пройти Модуль 1",
      "Пройден Модуль 1, предстоит пройти Модуль 2",
      "Пройден Модуль 2, предстоит пройти Модуль 3",
      "Пройден Модуль 3, предстоит пройти Модуль 4",
      "Пройден Модуль 4, курс завершен"
    ];

    // Создание меток для прогресса
    function createProgressMarks() {
      progressMarks.innerHTML = '';
      for (let i = 0; i <= 5; i++) {
        const mark = document.createElement('div');
        mark.className = 'progress-mark';
        mark.dataset.value = i;
        mark.innerHTML = `<span data-value="${i}"></span>`;
        progressMarks.appendChild(mark);
      }
      updateProgressMarks(0);
    }

    // Обновление меток прогресса
    function updateProgressMarks(value) {
      const marks = progressMarks.querySelectorAll('.progress-mark');
      marks.forEach((mark, index) => {
        if (index <= value) {
          mark.classList.add('active');
        } else {
          mark.classList.remove('active');
        }
      });
      
      // Обновление заполненной линии
      const percent = (value / 5) * 100;
      progressFilled.style.width = `${percent}%`;
    }

    // Показ уведомления
    function showNotification(message) {
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Получение Telegram ID из cookie
    function getTelegramUserId() {
      const match = document.cookie.match(/tg_user_id=([^;]+)/);
      return match ? parseInt(match[1]) : null;
    }

    // Проверка доступа
    function checkAccess() {
      currentUserTelegramId = getTelegramUserId();
      
      if (!currentUserTelegramId) {
        console.error('Telegram ID не найден');
        accessErrorDetails.textContent = "Telegram ID не найден в cookies";
        return false;
      }
      
      if (!config.allowedAdminIds.includes(currentUserTelegramId)) {
        console.error('Доступ запрещен для этого ID');
        accessErrorDetails.textContent = `Ваш ID: ${currentUserTelegramId} не имеет доступа`;
        return false;
      }
      
      return true;
    }

    // Загрузка пользователей
    async function fetchUsers() {
      try {
        const now = Date.now();
        if (now - lastUpdateTime < 1000) return;
        lastUpdateTime = now;
        
        const response = await fetch(
          `https://app.nocodb.com/api/${config.apiVersion}/db/data/${config.orgs}/${config.projectName}/${config.tableName}`,
          {
            headers: { 'xc-token': config.apiToken }
          }
        );
        
        if (!response.ok) {
          throw new Error(`Ошибка HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        allUsers = data.list || [];
        applyFilters();
      } catch (error) {
        console.error('Ошибка при загрузке пользователей:', error);
        showError('Ошибка загрузки данных');
      }
    }

    // Фильтрация и сортировка
    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase();
      
      // Фильтрация по поиску
      filteredUsers = allUsers.filter(user => {
        return (user.name && user.name.toLowerCase().includes(searchTerm)) ||
               (user.username && user.username.toLowerCase().includes(searchTerm));
      });
      
      // Применение выбранной сортировки
      if (currentSort === 'paid') {
        filteredUsers = filteredUsers.filter(user => user.oplata == 1);
      } else if (currentSort === 'unpaid') {
        filteredUsers = filteredUsers.filter(user => user.oplata != 1);
      } else if (currentSort === 'progress-asc') {
        filteredUsers.sort((a, b) => (a.progress || 0) - (b.progress || 0));
      } else if (currentSort === 'progress-desc') {
        filteredUsers.sort((a, b) => (b.progress || 0) - (a.progress || 0));
      }
      
      renderUsers(filteredUsers);
    }

    // Обновление чекбоксов сортировки
    function updateSortCheckboxes() {
      document.querySelectorAll('.sort-checkbox').forEach(checkbox => {
        checkbox.classList.toggle('checked', checkbox.dataset.sort === currentSort);
      });
    }

    // Отображение ошибки
    function showError(message) {
      usersContainer.innerHTML = `
        <div class="empty-state" style="color: var(--error);">
          ${message}
        </div>
      `;
    }

    // Рендеринг пользователей
    function renderUsers(users) {
      if (users.length === 0) {
        usersContainer.innerHTML = `
          <div class="empty-state">
            Пользователи не найдены
          </div>
        `;
        return;
      }
      
      const fragment = document.createDocumentFragment();
      
      users.forEach(user => {
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        
        // Имя пользователя
        const userName = document.createElement('div');
        userName.className = 'user-name';
        userName.textContent = user.name || 'Без имени';
        userCard.appendChild(userName);
        
        // Юзернейм
        const userUsername = document.createElement('div');
        userUsername.className = 'user-username';
        userUsername.textContent = `@${user.username || 'без username'}`;
        userCard.appendChild(userUsername);
        
        // Статус оплаты
        const paymentStatus = document.createElement('div');
        paymentStatus.className = `user-payment-status ${user.oplata == 1 ? 'paid' : 'unpaid'}`;
        paymentStatus.textContent = user.oplata == 1 ? 'Оплачен' : 'Не оплачен';
        userCard.appendChild(paymentStatus);
        
        // Кнопка шестеренки
        const settingsBtn = document.createElement('button');
        settingsBtn.className = 'settings-btn';
        settingsBtn.innerHTML = '⚙️';
        settingsBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          openSettingsModal(user);
        });
        userCard.appendChild(settingsBtn);
        
        // Прогресс
        const userProgress = document.createElement('div');
        userProgress.className = 'user-progress';
        userProgress.textContent = `${user.progress || 0}/5`; // Только цифры без "Прогресс: "
        userCard.appendChild(userProgress);
      });
      
      usersContainer.innerHTML = '';
      usersContainer.appendChild(fragment);
    }

    // Открытие модального окна настроек
    function openSettingsModal(user) {
      currentEditingUserId = user.Id;
      currentEditingUserData = {
        name: user.name,
        username: user.username,
        oplata: user.oplata == 1,
        progress: user.progress || 0
      };
      
      modalUserName.textContent = user.name || 'Без имени';
      modalUserUsername.textContent = `@${user.username || 'без username'}`;
      
      // Настройка статуса оплаты
      if (currentEditingUserData.oplata) {
        paymentStatusText.textContent = 'Оплачен';
        paymentStatusText.style.color = 'var(--success)';
        paymentCheckbox.checked = true;
      } else {
        paymentStatusText.textContent = 'Не оплачен';
        paymentStatusText.style.color = 'var(--error)';
        paymentCheckbox.checked = false;
      }
      
      // Настройка ползунка прогресса
      progressSlider.value = currentEditingUserData.progress;
      updateProgressMarks(currentEditingUserData.progress);
      updateProgressHint(currentEditingUserData.progress);
      
      settingsModal.classList.add('active');
    }

    // Обновление подсказки прогресса
    function updateProgressHint(progress) {
      progressHint.textContent = progressHints[progress] || '';
    }

    // Обновление данных пользователя
    async function updateUser(userId, data) {
      try {
        isSaving = true;
        modalSaveBtn.disabled = true;
        modalCancelBtn.disabled = true;
        modalSaveBtn.innerHTML = 'Сохранение <span class="spinner"></span>';
        
        const response = await fetch(
          `https://app.nocodb.com/api/${config.apiVersion}/db/data/${config.orgs}/${config.projectName}/${config.tableName}/${userId}`,
          {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'xc-token': config.apiToken
            },
            body: JSON.stringify({
              oplata: data.oplata ? 1 : 0,
              progress: data.progress
            })
          }
        );
        
        if (!response.ok) {
          throw new Error(`HTTP ошибка: ${response.status}`);
        }
        
        // Обновляем локальные данные
        const userIndex = allUsers.findIndex(user => user.Id === userId);
        if (userIndex !== -1) {
          allUsers[userIndex].oplata = data.oplata ? 1 : 0;
          allUsers[userIndex].progress = data.progress;
        }
        
        applyFilters();
        showNotification('Настройки успешно сохранены');
        return true;
      } catch (error) {
        console.error("Ошибка при обновлении пользователя:", error);
        showNotification(`Ошибка: ${error.message}`);
        return false;
      } finally {
        isSaving = false;
        modalSaveBtn.disabled = false;
        modalCancelBtn.disabled = false;
        modalSaveBtn.innerHTML = 'Сохранить';
      }
    }

    // Автоматическое обновление
    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(fetchUsers, 1000);
    }

    // Инициализация приложения
    function initializeApp() {
      if (checkAccess()) {
        adminContent.classList.remove('hidden');
        createProgressMarks();
        fetchUsers();
        startAutoRefresh();
      } else {
        accessDenied.classList.remove('hidden');
      }
    }

    // Обработчики событий
    function setupEventListeners() {
      // Сортировка
      sortBtn.addEventListener('click', () => {
        sortDropdown.classList.toggle('show');
      });
      
      // Обработка выбора фильтра оплаты
      document.querySelectorAll('[data-sort="paid"], [data-sort="unpaid"]').forEach(option => {
        option.addEventListener('click', (e) => {
          const sortType = option.dataset.sort;
          
          // Сбрасываем все чекбоксы в группе оплаты
          document.querySelectorAll('[data-sort="paid"], [data-sort="unpaid"] .sort-checkbox').forEach(cb => {
            cb.classList.remove('checked');
          });
          
          // Устанавливаем текущий чекбокс
          const checkbox = option.querySelector('.sort-checkbox');
          checkbox.classList.add('checked');
          
          // Обновляем текущую сортировку
          if (currentSort === sortType) {
            checkbox.classList.remove('checked');
            currentSort = null;
          } else {
            currentSort = sortType;
          }
        });
      });
      
      // Обработка выбора фильтра прогресса
      document.querySelectorAll('[data-sort="progress-asc"], [data-sort="progress-desc"]').forEach(option => {
        option.addEventListener('click', (e) => {
          const sortType = option.dataset.sort;
          
          // Сбрасываем все чекбоксы в группе прогресса
          document.querySelectorAll('[data-sort="progress-asc"], [data-sort="progress-desc"] .sort-checkbox').forEach(cb => {
            cb.classList.remove('checked');
          });
          
          // Устанавливаем текущий чекбокс
          const checkbox = option.querySelector('.sort-checkbox');
          checkbox.classList.add('checked');
          
          // Обновляем текущую сортировку
          if (currentSort === sortType) {
            checkbox.classList.remove('checked');
            currentSort = null;
          } else {
            currentSort = sortType;
          }
        });
      });
      
      // Сброс фильтра
      resetFilter.addEventListener('click', () => {
        document.querySelectorAll('.sort-checkbox').forEach(checkbox => {
          checkbox.classList.remove('checked');
        });
        currentSort = null;
        sortDropdown.classList.remove('show');
        applyFilters();
      });
      
      // Применение фильтра
      applyFilter.addEventListener('click', () => {
        sortDropdown.classList.remove('show');
        applyFilters();
      });
      
      // Закрытие dropdown при клике вне его
      document.addEventListener('click', (e) => {
        if (!sortBtn.contains(e.target) && !sortDropdown.contains(e.target)) {
          sortDropdown.classList.remove('show');
        }
      });
      
      // Поиск
      searchInput.addEventListener('input', applyFilters);
      
      // Чекбокс оплаты в модальном окне
      paymentCheckbox.addEventListener('change', () => {
        currentEditingUserData.oplata = paymentCheckbox.checked;
      });
      
      // Ползунок прогресса
      progressSlider.addEventListener('input', () => {
        const progress = parseInt(progressSlider.value);
        currentEditingUserData.progress = progress;
        updateProgressMarks(progress);
        updateProgressHint(progress);
      });
      
      // Кнопка отмены
      modalCancelBtn.addEventListener('click', () => {
        if (!isSaving) {
          settingsModal.classList.remove('active');
        }
      });
      
      // Кнопка сохранения
      modalSaveBtn.addEventListener('click', async () => {
        if (isSaving) return;
        
        const success = await updateUser(currentEditingUserId, currentEditingUserData);
        if (success) {
          settingsModal.classList.remove('active');
        }
      });
    }

    // Запуск приложения
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      initializeApp();
    });
  </script>
</body>
</html>
