<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Главное меню курса</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      text-align: center;
      max-width: 600px;
      margin: 0 auto;
    }

    .welcome-section {
      margin-bottom: 3rem;
    }

    .welcome-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 1rem;
      line-height: 1.2;
    }

    .welcome-subtitle {
      font-size: 1.2rem;
      color: #7f8c8d;
      margin-bottom: 2rem;
      line-height: 1.5;
    }

    .welcome-description {
      font-size: 1rem;
      color: #5a6c7d;
      line-height: 1.6;
      max-width: 500px;
    }

    .loading-message {
      font-size: 1.1rem;
      color: #6c757d;
      margin: 2rem 0;
    }

    .navigation-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      border-top: 1px solid #e0e0e0;
      padding: 1rem 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    .nav-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem 1rem;
      background: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 70px;
    }

    .nav-button:hover {
      background: #f8f9fa;
      border-radius: 8px;
    }

    .nav-icon {
      width: 24px;
      height: 24px;
      margin-bottom: 0.3rem;
      fill: #6c757d;
      transition: fill 0.2s ease;
    }

    .nav-button:hover .nav-icon {
      fill: #495057;
    }

    .nav-label {
      font-size: 0.8rem;
      color: #6c757d;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    /* Глобальная настройка для убирания всех обводок */
    * {
      outline: none !important;
      -webkit-tap-highlight-color: transparent !important;
    }

    *:focus {
      outline: none !important;
      box-shadow: none !important;
    }

    *:active {
      outline: none !important;
      box-shadow: none !important;
    }

    *:focus-visible {
      outline: none !important;
      box-shadow: none !important;
    }

    /* Специфичные настройки для кнопок */
    button {
      outline: none !important;
      border: none;
      -webkit-tap-highlight-color: transparent !important;
    }

    button:focus {
      outline: none !important;
      box-shadow: none !important;
    }

    button:active {
      outline: none !important;
      box-shadow: none !important;
    }

    button:focus-visible {
      outline: none !important;
      box-shadow: none !important;
    }

    /* Настройки для навигационных кнопок */
    .nav-button {
      outline: none !important;
      -webkit-tap-highlight-color: transparent !important;
    }

    .nav-button:focus {
      outline: none !important;
      box-shadow: none !important;
    }

    .nav-button:active {
      outline: none !important;
      box-shadow: none !important;
    }

    .nav-button:hover {
      background: #f8f9fa;
    }

    .nav-button.active {
      background: #e3f2fd;
    }

    .nav-button:hover .nav-icon,
    .nav-button.active .nav-icon {
      fill: #2196F3;
    }

    .nav-button:hover .nav-label,
    .nav-button.active .nav-label {
      color: #2196F3;
    }

    @media (max-width: 768px) {
      .welcome-title {
        font-size: 1.8rem;
      }

      .welcome-subtitle {
        font-size: 1rem;
      }

      .main-content {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="main-content">
    <div class="welcome-section" id="welcomeSection">
      <h1 class="welcome-title">Добро пожаловать в курс!</h1>
      <p class="welcome-subtitle">Изучайте новые навыки с удовольствием</p>
      <p class="welcome-description">
        Здесь вы найдете все необходимые материалы для успешного обучения. 
        Выберите нужный раздел в навигации внизу экрана и начните свой путь к новым знаниям.
      </p>
      <div class="loading-message" id="loadingMessage">Загружаем ваши данные...</div>
    </div>
  </div>

  <div class="navigation-panel">
    <button class="nav-button" id="guidesBtn">
      <svg class="nav-icon" viewBox="0 0 24 24">
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
      </svg>
      <span class="nav-label">Курс</span>
    </button>

    <button class="nav-button" id="favoriteBtn">
      <svg class="nav-icon" viewBox="0 0 24 24">
        <path d="M4 2v20l8-4 8 4V2H4z"/>
      </svg>
      <span class="nav-label">Избранное</span>
    </button>

    <button class="nav-button" id="aiToolsBtn">
      <svg class="nav-icon" viewBox="0 0 24 24">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
      </svg>
      <span class="nav-label">ИИ чат</span>
    </button>

    <button class="nav-button" id="profileBtn">
      <svg class="nav-icon" viewBox="0 0 24 24">
        <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 7V9C15 11.7 12.7 14 10 14S5 11.7 5 9V7H3V9C3 12.4 5.4 15.1 8.5 15.8V18H7V20H17V18H15.5V15.8C18.6 15.1 21 12.4 21 9Z"/>
      </svg>
      <span class="nav-label">Профиль</span>
    </button>
  </div>

  <script>
    // Конфигурация NocoDB
    const config = {
      orgs: 'weamcfo6',
      projectName: 'p27jdsmk69wuimh',
      tableName: 'mc6qh91f060pv4y',
      apiToken: 'bocQfycJpJsTG_tbwEf8ma8E5rhoig0njMDXFWtJ',
      baseUrl: 'https://app.nocodb.com/api/v1/db/data'
    };

    // Переменные для работы с Telegram WebApp
    let tg = window.Telegram.WebApp;
    let userData = null;
    let isInitialized = false;

    // Установить cookie
    function setCookie(name, value, days = 365) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
    }

    // Получить данные пользователя из Telegram WebApp
    function getTelegramUserData() {
      try {
        // Расширяем приложение на весь экран
        tg.expand();

        // Получаем данные пользователя
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
          const user = tg.initDataUnsafe.user;
          console.log('Получены данные пользователя Telegram:', user);

          return {
            id: user.id.toString(),
            username: user.username || '',
            first_name: user.first_name || '',
            last_name: user.last_name || '',
            language_code: user.language_code || 'ru'
          };
        }

        throw new Error('Данные пользователя недоступны');
      } catch (error) {
        console.error('Ошибка получения данных пользователя:', error);
        throw error;
      }
    }

    // Сохранить данные пользователя в cookies
    function saveUserData(userData) {
      setCookie('tg_user_id', userData.id);
      setCookie('tg_username', userData.username);
      setCookie('tg_name', `${userData.first_name} ${userData.last_name}`.trim());
      setCookie('tg_language', userData.language_code);
    }

    // Проверить пользователя в NocoDB
    async function checkUserInDatabase(userData) {
      console.log('Проверяем пользователя в базе данных:', userData);

      try {
        // Получаем все записи из таблицы
        const listResponse = await fetch(`${config.baseUrl}/${config.orgs}/${config.projectName}/${config.tableName}`, {
          method: 'GET',
          headers: {
            'xc-token': config.apiToken,
            'Content-Type': 'application/json'
          }
        });

        if (!listResponse.ok) {
          throw new Error(`Ошибка получения данных: ${listResponse.status} ${listResponse.statusText}`);
        }

        const data = await listResponse.json();
        console.log('Получены данные из базы:', data);

        // Ищем пользователя по tg_user_id
        const existingUser = data.list ? data.list.find(user => user.tg_user_id && user.tg_user_id.toString() === userData.id.toString()) : null;

        if (existingUser) {
          console.log('Пользователь найден в базе данных:', existingUser);
          return true;
        }

        console.log('Пользователь не найден, создаем новую запись...');

        // Создаем нового пользователя
        const newUserData = {
          tg_user_id: userData.id,
          name: `${userData.first_name} ${userData.last_name}`.trim() || 'Не указано',
          username: userData.username || 'Не указан',
          progress: 0,
          oplata: 0,
          data: ''
        };

        console.log('Данные для создания пользователя:', newUserData);

        const createResponse = await fetch(`${config.baseUrl}/${config.orgs}/${config.projectName}/${config.tableName}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'xc-token': config.apiToken
          },
          body: JSON.stringify(newUserData)
        });

        if (!createResponse.ok) {
          const errorText = await createResponse.text();
          throw new Error(`Ошибка создания пользователя: ${createResponse.status} ${createResponse.statusText} - ${errorText}`);
        }

        const createdUser = await createResponse.json();
        console.log('Пользователь успешно создан:', createdUser);
        return true;

      } catch (error) {
        console.error('Ошибка при работе с базой данных:', error);

        // Уведомляем пользователя об ошибке через Telegram WebApp
        if (tg.showAlert) {
          tg.showAlert('Произошла ошибка при проверке данных пользователя. Попробуйте позже.');
        }

        throw error;
      }
    }

    // Инициализация приложения
    async function initApp() {
      try {
        console.log('Начинаем инициализацию приложения...');

        // Проверяем доступность Telegram WebApp
        if (!window.Telegram || !window.Telegram.WebApp) {
          throw new Error('Приложение должно быть запущено в Telegram');
        }

        // Инициализируем Telegram WebApp
        tg.ready();
        console.log('Telegram WebApp инициализирован');

        // Получаем данные пользователя
        userData = getTelegramUserData();
        console.log('Полученные данные пользователя:', userData);

        // Сохраняем в cookies
        saveUserData(userData);
        console.log('Данные сохранены в cookies');

        // Проверяем в базе данных
        await checkUserInDatabase(userData);

        // Скрываем сообщение о загрузке
        document.getElementById('loadingMessage').style.display = 'none';

        console.log('Инициализация завершена успешно');
        isInitialized = true;

      } catch (error) {
        console.error('Ошибка инициализации:', error);

        // Показываем ошибку пользователю
        const loadingMessage = document.getElementById('loadingMessage');
        loadingMessage.textContent = `Ошибка: ${error.message}`;
        loadingMessage.style.color = '#dc3545';

        // Если есть возможность, показываем alert через Telegram
        if (tg.showAlert) {
          tg.showAlert(`Ошибка инициализации: ${error.message}`);
        }
      }
    }

    // Обработчики навигации
    document.getElementById('guidesBtn').addEventListener('click', () => {
      if (!isInitialized) {
        console.warn('Приложение еще не инициализировано');
        return;
      }
      window.location.href = 'gaid.html';
    });

    document.getElementById('favoriteBtn').addEventListener('click', () => {
      window.location.href = 'favorite.html';
    });

    document.getElementById('aiToolsBtn').addEventListener('click', () => {
      console.log('AI Tools clicked');
      if (tg.showAlert) {
        tg.showAlert('Раздел находится в разработке');
      }
    });

    document.getElementById('profileBtn').addEventListener('click', () => {
      console.log('Profile clicked');
      if (tg.showAlert) {
        tg.showAlert('Раздел находится в разработке');
      }
    });

    // Запускаем инициализацию после загрузки DOM
    document.addEventListener('DOMContentLoaded', initApp);

    // Обработка события закрытия приложения
    tg.onEvent('mainButtonClicked', function() {
      tg.close();
    });

    // Дополнительная проверка на случай, если скрипт Telegram не загрузился
    window.addEventListener('load', function() {
      setTimeout(() => {
        if (!isInitialized && window.Telegram && window.Telegram.WebApp) {
          console.log('Повторная попытка инициализации...');
          initApp();
        }
      }, 1000);
    });
  </script>
</body>
</html>
