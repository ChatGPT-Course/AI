<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PuzzleBot User Data</title>
    <style>
        body {
            padding: 20px;
            font-family: Arial;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        #result {
            white-space: pre-wrap;
            padding: 15px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 10px;
            margin-top: 15px;
        }
        button {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>
<body>
    <button onclick="initializeApp()">Инициализировать приложение</button>
    <div id="result">Статус: Ожидание инициализации...</div>

    <script>
        const API_KEY = 'i5vkuteSbTI65FSFoLahqgpEmpkQUbZJ';
        const CHAT_ID = '7533493609';

        // Основные функции
        function log(message) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent += `\n${new Date().toLocaleTimeString()}: ${message}`;
        }

        function getTelegramUser() {
            try {
                if (!window.Telegram?.WebApp) {
                    throw new Error("Telegram WebApp API не доступен");
                }

                const webApp = Telegram.WebApp;
                
                // Проверка инициализации
                if (!webApp.initDataUnsafe) {
                    throw new Error("Данные инициализации не получены");
                }

                // Получаем пользовательские данные
                const user = webApp.initDataUnsafe.user;
                
                if (!user) {
                    throw new Error("Данные пользователя отсутствуют в initDataUnsafe");
                }

                if (!user.id) {
                    throw new Error("User ID не найден");
                }

                return user;

            } catch (error) {
                log(`Ошибка: ${error.message}`);
                return null;
            }
        }

        async function getCategories() {
            const user = getTelegramUser();
            if (!user) return;

            try {
                const url = new URL('https://api.puzzlebot.top/');
                url.searchParams.append('token', API_KEY);
                url.searchParams.append('method', 'getUserInChatStatus');
                url.searchParams.append('user_id', user.id);
                url.searchParams.append('chat_id', CHAT_ID);
                url.searchParams.append('page', '1');

                const response = await fetch(url);
                const data = await response.json();
                
                log("Ответ API получен:");
                log(JSON.stringify(data, null, 2));

            } catch (error) {
                log(`Ошибка запроса: ${error.message}`);
            }
        }

        function initializeApp() {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = "Инициализация...\n";

            if (window.Telegram?.WebApp) {
                const webApp = Telegram.WebApp;
                
                // Версия WebApp
                log(`Версия WebApp: ${webApp.version || 'неизвестна'}`);
                
                // Параметры инициализации
                log(`Init data: ${JSON.stringify(webApp.initData)}`);
                log(`Init data unsafe: ${JSON.stringify(webApp.initDataUnsafe)}`);
                
                // Инициализация приложения
                webApp.ready();
                webApp.expand();
                
                // Проверка данных пользователя
                const user = getTelegramUser();
                if (user) {
                    log("\nДанные пользователя:");
                    log(`ID: ${user.id}`);
                    log(`Имя: ${user.first_name || 'не указано'}`);
                    log(`Username: @${user.username || 'не указан'}`);
                    
                    // Запуск запроса после успешной инициализации
                    setTimeout(getCategories, 500);
                }

                // Настройка основной кнопки
                webApp.MainButton
                    .setText('Обновить данные')
                    .onClick(getCategories)
                    .show();

            } else {
                log("Это не Telegram WebView! Работа в ограниченном режиме");
            }
        }
    </script>
</body>
</html>
