<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle Bot Debug</title>
    <style>
        body { padding: 20px; font-family: Arial; }
        #log { 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 15px; 
            margin-top: 15px; 
            border-radius: 5px; 
            max-height: 300px; 
            overflow-y: auto; 
        }
        input, button { 
            padding: 10px; 
            margin: 5px; 
            width: 100%; 
            box-sizing: border-box; 
        }
    </style>
</head>
<body>
    <input type="text" id="userId" placeholder="User ID (автоопределение в Telegram)">
    <button onclick="fetchData()">Проверить запрос</button>
    <div id="log">Журнал запросов:</div>

    <script>
        const API_KEY = 'i5vkuteSbTI65FSFoLahqgpEmpkQUbZJ';
        const CHAT_ID = 'private';

        // Автоматическое определение UserID в Telegram
        function detectUserId() {
            try {
                const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
                if (tgUser?.id) {
                    document.getElementById('userId').value = tgUser.id;
                    return tgUser.id;
                }
            } catch(e) {
                log('Ошибка определения UserID из Telegram');
            }
            return null;
        }

        // Логирование
        function log(message) {
            const now = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            logElement.innerHTML += `[${now}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Проверка базового запроса
        async function testConnection() {
            try {
                const testUrl = `https://api.puzzlebot.top/?token=${API_KEY}&method=test`;
                const response = await fetch(testUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP Status: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch(error) {
                log(`Тестовый запрос failed: ${error.message}`);
                throw error;
            }
        }

        // Основная функция
        async function fetchData() {
            log('--- НАЧАЛО ЗАПРОСА ---');
            
            try {
                // 1. Проверка подключения
                const testResult = await testConnection();
                log(`Тестовый запрос: ${JSON.stringify(testResult)}`);

                // 2. Получение UserID
                const userId = document.getElementById('userId').value || detectUserId();
                if (!userId) {
                    log('Ошибка: UserID не определен');
                    return;
                }
                log(`Используется UserID: ${userId}`);

                // 3. Запрос статуса пользователя
                const statusUrl = `https://api.puzzlebot.top/?token=${API_KEY}&method=getUserInChatStatus&user_id=${userId}&chat_id=${CHAT_ID}`;
                log(`Отправка запроса: ${statusUrl}`);
                
                const startTime = Date.now();
                const response = await fetch(statusUrl);
                const requestTime = Date.now() - startTime;
                
                log(`Ответ получен за ${requestTime}ms`);
                log(`HTTP Status: ${response.status}`);
                log(`Headers: ${JSON.stringify([...response.headers])}`);

                // 4. Обработка ответа
                const data = await response.json();
                log(`Ответ API: ${JSON.stringify(data)}`);

                if (data.code === 0) {
                    log('Успешный ответ от API');
                } else {
                    log(`Ошибка API: ${data.message}`);
                }

            } catch(error) {
                log(`Критическая ошибка: ${error.message}`);
                log('Возможные причины:');
                log('1. Блокировка CORS');
                log('2. Неверный API ключ');
                log('3. Проблемы сети');
                log('4. Ограничения Telegram WebView');
            }
            
            log('--- КОНЕЦ ЗАПРОСА ---');
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
            }
            detectUserId();
        });
    </script>
</body>
</html>
