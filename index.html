<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle Bot Categories</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        #log {
            background: #000;
            color: #0f0;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }
        button {
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <button id="getBtn">Получить категории</button>
    <div id="log">Готов к работе...</div>

    <script>
        // Конфиг
        const API_KEY = 'i5vkuteSbTI65FSFoLahqgpEmpkQUbZJ';
        const BOT_ID = '7533493609';
        
        // Элементы
        const log = document.getElementById('log');
        const getBtn = document.getElementById('getBtn');
        
        // Логирование
        function addLog(msg) {
            log.innerHTML += `> ${msg}<br>`;
            log.scrollTop = log.scrollHeight;
        }
        
        // Получение user_id из Telegram
        function getTelegramUserId() {
            if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
                return Telegram.WebApp.initDataUnsafe.user.id;
            }
            return null;
        }
        
        // Запрос к API Puzzle Bot
        async function puzzleApiRequest(method, params = {}) {
            const url = new URL('https://api.puzzlebot.top/');
            url.searchParams.append('token', API_KEY);
            url.searchParams.append('method', method);
            
            for (const [key, value] of Object.entries(params)) {
                url.searchParams.append(key, value);
            }
            
            try {
                addLog(`Отправка запроса: ${method}`);
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code !== 0) {
                    throw new Error(data.message || 'Unknown error');
                }
                
                return data.data;
            } catch (error) {
                addLog(`Ошибка: ${error.message}`);
                throw error;
            }
        }
        
        // Основная функция
        async function getCategories() {
            const userId = getTelegramUserId();
            if (!userId) {
                addLog('Ошибка: Не удалось получить user_id');
                return;
            }
            
            addLog(`User ID: ${userId}`);
            
            try {
                // Способ 1: Через getUserInChatStatus
                addLog('\nСпособ 1: getUserInChatStatus');
                const userStatus = await puzzleApiRequest('getUserInChatStatus', {
                    user_id: userId,
                    chat_id: 'private',
                    page: 1
                });
                
                if (userStatus.categories) {
                    addLog(`Категории: ${userStatus.categories.join(', ')}`);
                } else {
                    addLog('Категории не найдены');
                }
                
                // Способ 2: Через getChatCategories + фильтрация
                addLog('\nСпособ 2: getChatCategories');
                const allCategories = await puzzleApiRequest('getChatCategories', {
                    tg_chat_id: 'private'
                });
                
                addLog(`Все категории чата (${allCategories.length}):`);
                allCategories.forEach(cat => {
                    addLog(`- ${cat.name} (ID: ${cat.id})`);
                });
                
                // Тестовый запрос
                addLog('\nТестовый запрос:');
                const testResult = await puzzleApiRequest('test');
                addLog(`Тест: ${testResult}`);
                
            } catch (error) {
                addLog(`Финальная ошибка: ${error.message}`);
            }
        }
        
        // Инициализация
        getBtn.addEventListener('click', getCategories);
        addLog('Mini App готов к работе');
        addLog(`API Key: ${API_KEY}`);
        addLog(`Bot ID: ${BOT_ID}`);
        
        // Автозапуск при открытии
        setTimeout(getCategories, 1000);
    </script>
</body>
</html>
