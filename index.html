<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle Bot - Категории пользователя</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .container {
            max-width: 100%;
        }
        h1 {
            font-size: 20px;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color);
        }
        .card {
            background: var(--tg-theme-secondary-bg-color, #f4f4f4);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: var(--tg-theme-button-color, #4CAF50);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            margin: 16px 0;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 10px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin-bottom: 12px;
            box-sizing: border-box;
        }
        .console {
            background: var(--tg-theme-secondary-bg-color, #f4f4f4);
            border-radius: 12px;
            padding: 12px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .log-entry {
            margin-bottom: 4px;
            line-height: 1.4;
        }
        .timestamp {
            color: var(--tg-theme-hint-color, #999999);
            margin-right: 6px;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 50%;
            border-top-color: var(--tg-theme-button-color, #4CAF50);
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Категории пользователя</h1>
        
        <div class="card" id="userInfo">
            Загрузка данных пользователя...
        </div>
        
        <input type="text" class="input-field" id="apiKey" placeholder="API ключ из настроек бота">
        <input type="text" class="input-field" id="chatId" placeholder="ID чата (или 'private')">
        
        <button class="btn" id="getButton">
            <span id="buttonText">Получить категории</span>
        </button>
        
        <div class="card">
            <h2>Результат запроса</h2>
            <div class="console" id="console"></div>
        </div>
    </div>

    <script>
        // Элементы интерфейса
        const getButton = document.getElementById('getButton');
        const buttonText = document.getElementById('buttonText');
        const consoleElement = document.getElementById('console');
        const apiKeyInput = document.getElementById('apiKey');
        const chatIdInput = document.getElementById('chatId');
        const userInfoElement = document.getElementById('userInfo');
        
        // Данные Telegram WebApp
        let tg = null;
        let tgUserId = null;
        
        // Инициализация Telegram WebApp
        function initTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = Telegram.WebApp;
                tg.expand();
                
                // Получаем данные пользователя
                const user = tg.initDataUnsafe?.user;
                tgUserId = user?.id;
                
                if (tgUserId) {
                    userInfoElement.innerHTML = `
                        <strong>ID пользователя:</strong> ${tgUserId}<br>
                        <strong>Имя:</strong> ${user.first_name || 'не указано'}<br>
                        <strong>Username:</strong> ${user.username ? '@' + user.username : 'не указан'}
                    `;
                    
                    // Пытаемся получить API ключ из параметров запуска
                    const initData = new URLSearchParams(tg.initData);
                    const apiKey = initData.get('api_key') || initData.get('token');
                    if (apiKey) {
                        apiKeyInput.value = apiKey;
                    }
                } else {
                    userInfoElement.innerHTML = 'Не удалось получить данные пользователя';
                }
                
                // Настройка темы
                document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
            } else {
                userInfoElement.innerHTML = 'Этот интерфейс предназначен для работы внутри Telegram';
            }
        }
        
        // Логирование в консоль
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            consoleElement.appendChild(entry);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        // Выполнение запроса к API Puzzle Bot
        async function fetchPuzzleBotAPI(method, params = {}) {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                throw new Error('API ключ не указан');
            }
            
            const baseUrl = 'https://api.puzzlebot.top/';
            const urlParams = new URLSearchParams({
                token: apiKey,
                method: method,
                ...params
            });
            
            const url = `${baseUrl}?${urlParams.toString()}`;
            log(`Отправка запроса: ${method}`);
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ошибка ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.code !== 0) {
                    throw new Error(`API ошибка: ${data.message || 'неизвестная ошибка'}`);
                }
                
                return data.data;
            } catch (error) {
                log(`Ошибка: ${error.message}`);
                throw error;
            }
        }
        
        // Получение категорий пользователя
        async function getUserCategories() {
            const chatId = chatIdInput.value.trim();
            if (!chatId) {
                throw new Error('ID чата не указан');
            }
            
            if (!tgUserId) {
                throw new Error('ID пользователя не определен');
            }
            
            // Показываем состояние загрузки
            getButton.disabled = true;
            buttonText.innerHTML = `<span class="spinner"></span> Загрузка...`;
            
            try {
                // 1. Получаем статус пользователя
                const userStatus = await fetchPuzzleBotAPI('getUserInChatStatus', {
                    user_id: tgUserId,
                    chat_id: chatId,
                    page: 1
                });
                
                log(`\nСтатус пользователя в чате ${chatId}:`);
                log(`- Имя: ${userStatus.first_name} ${userStatus.last_name || ''}`);
                log(`- Username: @${userStatus.username || 'не указан'}`);
                log(`- Статус: ${userStatus.joined === 1 ? 'В чате' : userStatus.joined === 0 ? 'Покинул чат' : 'Заблокирован'}`);
                
                // 2. Получаем список всех категорий чата
                const chatCategories = await fetchPuzzleBotAPI('getChatCategories', {
                    tg_chat_id: chatId
                });
                
                log(`\nДоступные категории в чате (${chatCategories.length}):`);
                chatCategories.forEach(cat => {
                    log(`- ${cat.name} (ID: ${cat.id}) ${cat.is_main ? '(Основная)' : ''}`);
                });
                
                // 3. Фильтруем категории пользователя
                if (userStatus.categories && userStatus.categories.length > 0) {
                    const userCategories = chatCategories.filter(cat => 
                        userStatus.categories.includes(cat.id)
                    );
                    
                    log(`\nКатегории пользователя (${userCategories.length}):`);
                    if (userCategories.length > 0) {
                        userCategories.forEach(cat => {
                            log(`- ${cat.name} (ID: ${cat.id})`);
                        });
                    } else {
                        log('- Нет совпадений (возможно, ID категорий устарели)');
                    }
                } else {
                    log('\nУ пользователя нет категорий в этом чате');
                }
                
            } finally {
                // Восстанавливаем кнопку
                getButton.disabled = false;
                buttonText.textContent = 'Получить категории';
            }
        }
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', initTelegramWebApp);
        
        // Обработчик кнопки
        getButton.addEventListener('click', () => {
            consoleElement.innerHTML = '';
            getUserCategories().catch(e => console.error(e));
        });
    </script>
</body>
</html>
