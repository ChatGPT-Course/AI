<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI eggo</title>
    <style>
        :root {
            --primary: #FFA500;
            --primary-light: #FFD166;
            --bg: #FAFAFA;
            --chat-bg: #FFFFFF;
            --text: #333333;
            --text-light: #666666;
            --accent: #4CC9F0;
            --border: rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        .header { padding: 16px; display: flex; align-items: center; border-bottom: 1px solid var(--border); background: var(--chat-bg); position: relative; }
        .back-button { width: 40px; height: 40px; border-radius: 8px; background: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .back-button:hover { background: var(--primary-light); transform: translateX(-2px); }
        .back-button svg { width: 20px; height: 20px; fill: white; }
        .header-title { font-size: 1.25rem; font-weight: 600; color: var(--text); position: absolute; left: 50%; transform: translateX(-50%); }
        .chat-container { flex: 1; display: flex; flex-direction: column; max-width: 800px; width: 100%; margin: 0 auto; padding: 16px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; background: var(--chat-bg); border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05); margin-bottom: 16px; }
        .message { max-width: 85%; display: flex; gap: 12px; animation: fadeIn 0.3s ease; }
        .user-message { align-self: flex-end; flex-direction: row-reverse; }
        .bot-message { align-self: flex-start; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; font-weight: bold; margin-top: 4px; }
        .bot-avatar { background: var(--accent); }
        .message-content { padding: 12px 16px; border-radius: 12px; line-height: 1.4; }
        .user-message .message-content { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .bot-message .message-content { background: rgba(0, 0, 0, 0.03); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .typing-indicator { display: inline-flex; gap: 6px; padding: 12px 16px; background: rgba(0, 0, 0, 0.03); border-radius: 12px; border-bottom-left-radius: 4px; align-items: center; }
        .typing-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        .input-container { display: flex; gap: 8px; padding: 8px; background: var(--chat-bg); border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05); }
        #user-input { flex: 1; padding: 12px 16px; border: 1px solid var(--border); border-radius: 24px; font-size: 1rem; outline: none; transition: all 0.2s; }
        #user-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(255, 165, 0, 0.2); }
        #send-button { padding: 12px 20px; border: none; border-radius: 24px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        #send-button:hover { background: var(--primary-light); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
        @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-4px); } }
        @media (max-width: 600px) { .chat-container { padding: 8px; } .message { max-width: 90%; } .avatar { width: 32px; height: 32px; font-size: 0.9rem; } #user-input { padding: 10px 14px; } #send-button { padding: 10px 16px; } }
        .loader { position: fixed; z-index: 1000; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--primary); }
        .modal { position: fixed; z-index: 1001; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 32px 24px; border-radius: 16px; box-shadow: 0 2px 16px rgba(0,0,0,0.12); text-align: center; max-width: 90vw; }
        .modal-content h2 { margin-bottom: 16px; }
        .modal-content button { margin-top: 20px; padding: 12px 24px; border: none; border-radius: 8px; background: var(--primary); color: #fff; font-size: 1rem; cursor: pointer; }
        .modal-content button:hover { background: var(--primary-light); }
    </style>
</head>
<body>
    <div class="loader" id="loader">Загрузка...</div>
    <div id="modal" class="modal" style="display:none;">
        <div class="modal-content" id="modal-content"></div>
    </div>
    <div class="header">
        <a href="index.html" class="back-button">
            <svg viewBox="0 0 24 24">
                <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
            </svg>
        </a>
        <div class="header-title">AI eggo</div>
    </div>
    <div class="chat-container" id="chat-container" style="display:none;">
        <div class="chat-messages" id="chat-output"></div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Напишите сообщение..." autocomplete="off">
            <button id="send-button" onclick="sendMessage()">Отправить</button>
        </div>
    </div>
    <script>
        // === НАСТРОЙКИ FIREBASE ===
        // Замените на свой URL Firebase Realtime Database
        const FIREBASE_URL = 'https://vrot-x-7a48f-default-rtdb.firebaseio.com'; // без / на конце
        // Путь к пользователям в БД, например: 'users'
        const USERS_PATH = 'users';

        // === Получение Telegram ID из cookie ===
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        function getTelegramId() {
            return getCookie('tg_user_id');
        }

        // === Получение данных пользователя из Firebase ===
        async function fetchUserData(telegramId) {
            const url = `${FIREBASE_URL}/${USERS_PATH}/${telegramId}.json`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Ошибка доступа к БД');
            return await res.json();
        }

        // === Проверка доступа ===
        function parseMskDate(str) {
            // Ожидается формат: дд.мм.гггг чч:мм:сс
            if (!str) return null;
            const [datePart, timePart] = str.split(' ');
            if (!datePart || !timePart) return null;
            const [day, month, year] = datePart.split('.').map(Number);
            const [hour, minute, second] = timePart.split(':').map(Number);
            // Создаём дату в UTC, потом прибавляем 3 часа для МСК
            return new Date(Date.UTC(year, month - 1, day, hour - 3, minute, second));
        }
        function isAccessAllowed(user) {
            if (!user) return { allowed: false, reason: 'not_found' };
            if (user.oplata !== 1) return { allowed: false, reason: 'no_payment' };
            // Даты в формате дд.мм.гггг чч:мм:сс (МСК)
            const now = new Date();
            // Переводим текущее время в МСК
            const nowMsk = new Date(now.getTime() + (3 - now.getTimezoneOffset()/60)*60*60*1000);
            const dateOplata = parseMskDate(user.date_oplata);
            let dateExpired = parseMskDate(user.date_expired);
            // Если date_expired не задан, вычисляем его как date_oplata + 14 дней
            if (!dateExpired && dateOplata) {
                dateExpired = new Date(dateOplata.getTime() + 14 * 24 * 60 * 60 * 1000);
            }
            if (!dateOplata || !dateExpired) return { allowed: false, reason: 'date_error' };
            if (nowMsk >= dateOplata && nowMsk <= dateExpired) {
                return { allowed: true };
            } else {
                return { allowed: false, reason: 'expired', dateExpired };
            }
        }

        // === UI функции ===
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }
        function showModal(html) {
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';
        }
        function hideModal() {
            document.getElementById('modal').style.display = 'none';
        }
        function showChat() {
            document.getElementById('chat-container').style.display = 'flex';
        }

        // === Логика старта ===
        let currentUser = null;
        let accessCheckInterval = null;
        async function checkAccessAndUpdateUI() {
            if (!currentUser) return;
            const access = isAccessAllowed(currentUser);
            if (access.allowed) {
                showChat();
                hideModal();
            } else if (access.reason === 'expired') {
                document.getElementById('chat-container').style.display = 'none';
                showModal(`
                    <h2>Срок доступа истёк</h2>
                    <p>ИИ был доступен в течение 14 дней после покупки курса.<br>Срок действия истёк: <b>${access.dateExpired ? access.dateExpired.toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' }) : ''}</b></p>
                    <button onclick="window.location.href='index.html'">В меню</button>
                `);
            }
        }
        async function init() {
            showLoader(true);
            try {
                const telegramId = getTelegramId();
                if (!telegramId) {
                    showLoader(false);
                    showModal(`
                        <h2>Ошибка</h2>
                        <p>Не удалось получить ваш Telegram ID.<br>Пожалуйста, откройте сайт через Telegram Mini App.</p>
                        <button onclick="window.location.href='index.html'">В меню</button>
                    `);
                    return;
                }
                const user = await fetchUserData(telegramId);
                currentUser = user;
                const access = isAccessAllowed(user);
                showLoader(false);
                if (!user || access.reason === 'not_found' || access.reason === 'no_payment') {
                    showModal(`
                        <h2>Доступ ограничен</h2>
                        <p>ИИ доступен только в полном курсе.<br>Оформите оплату для получения доступа.</p>
                        <button onclick="window.location.href='oplata.html'">Перейти к оплате</button>
                    `);
                } else if (access.reason === 'expired') {
                    showModal(`
                        <h2>Срок доступа истёк</h2>
                        <p>ИИ был доступен в течение 14 дней после покупки курса.<br>Срок действия истёк: <b>${access.dateExpired ? access.dateExpired.toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' }) : ''}</b></p>
                        <button onclick="window.location.href='index.html'">В меню</button>
                    `);
                } else if (access.allowed) {
                    showChat();
                    // Запускаем периодическую проверку доступа
                    if (accessCheckInterval) clearInterval(accessCheckInterval);
                    accessCheckInterval = setInterval(checkAccessAndUpdateUI, 3000);
                }
            } catch (e) {
                showLoader(false);
                showModal(`
                    <h2>Ошибка</h2>
                    <p>${e.message}</p>
                    <button onclick="window.location.reload()">Повторить</button>
                `);
            }
        }
        window.addEventListener('DOMContentLoaded', init);

        // === Ваш код чата (без изменений) ===
        const API_ENDPOINT = 'https://openai-proxy.egorspirin10.workers.dev/';
        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? '' : 'bot-avatar'}`;
            avatar.textContent = isUser ? 'Я' : 'AI';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            if (!isUser && text === 'typing') {
                contentDiv.className = 'typing-indicator';
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'typing-dot';
                    contentDiv.appendChild(dot);
                }
            } else {
                contentDiv.textContent = text;
            }
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatOutput.appendChild(messageDiv);
            chatOutput.scrollTop = chatOutput.scrollHeight;
            return contentDiv;
        }
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            userInput.value = '';
            sendButton.disabled = true;
            addMessage(message, true);
            const typingIndicator = addMessage('typing', false);
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                if (!response.ok) throw new Error('Ошибка сервера');
                const data = await response.json();
                typingIndicator.className = 'message-content';
                typingIndicator.textContent = data.reply;
            } catch (error) {
                typingIndicator.className = 'message-content';
                typingIndicator.textContent = `Ошибка: ${error.message}`;
            } finally {
                sendButton.disabled = false;
                chatOutput.scrollTop = chatOutput.scrollHeight;
                userInput.focus();
            }
        }
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        userInput.focus();
    </script>
</body>
</html>
