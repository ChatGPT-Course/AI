<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI eggo</title>
    <style>
        :root {
            --primary: #FFA500;
            --primary-light: #FFD166;
            --bg: #FAFAFA;
            --chat-bg: #FFFFFF;
            --text: #333333;
            --text-light: #666666;
            --accent: #4CC9F0;
            --border: rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        .header { padding: 16px; display: flex; align-items: center; border-bottom: 1px solid var(--border); background: var(--chat-bg); position: relative; }
        .back-button { width: 40px; height: 40px; border-radius: 8px; background: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .back-button:hover { background: var(--primary-light); transform: translateX(-2px); }
        .back-button svg { width: 20px; height: 20px; fill: white; }
        .header-title { font-size: 1.25rem; font-weight: 600; color: var(--text); position: relative; margin: 0 auto; }
        .chat-container { flex: 1; display: flex; flex-direction: column; max-width: 800px; width: 100%; margin: 0 auto; padding: 16px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; background: var(--chat-bg); border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05); margin-bottom: 16px; }
        .message { max-width: 85%; display: flex; gap: 12px; animation: fadeIn 0.3s ease; }
        .user-message { align-self: flex-end; flex-direction: row-reverse; }
        .bot-message { align-self: flex-start; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; font-weight: bold; margin-top: 4px; }
        .bot-avatar { background: var(--accent); }
        .message-content { padding: 12px 16px; border-radius: 12px; line-height: 1.4; }
        .user-message .message-content { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .bot-message .message-content { background: rgba(0, 0, 0, 0.03); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .typing-indicator { display: inline-flex; gap: 6px; padding: 12px 16px; background: rgba(0, 0, 0, 0.03); border-radius: 12px; border-bottom-left-radius: 4px; align-items: center; }
        .typing-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        .input-container { display: flex; gap: 8px; padding: 8px; background: var(--chat-bg); border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05); }
        #user-input { flex: 1; padding: 12px 16px; border: 1px solid var(--border); border-radius: 24px; font-size: 1rem; outline: none; transition: all 0.2s; }
        #user-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(255, 165, 0, 0.2); }
        #send-button { padding: 12px 20px; border: none; border-radius: 24px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        #send-button:hover { background: var(--primary-light); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
        @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-4px); } }
        @media (max-width: 600px) { .chat-container { padding: 8px; } .message { max-width: 90%; } .avatar { width: 32px; height: 32px; font-size: 0.9rem; } #user-input { padding: 10px 14px; } #send-button { padding: 10px 16px; } }
        .loader { position: fixed; z-index: 1000; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--primary); }
        .modal { position: fixed; z-index: 1001; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 32px 24px; border-radius: 16px; box-shadow: 0 2px 16px rgba(0,0,0,0.12); text-align: center; max-width: 90vw; }
        .modal-content h2 { margin-bottom: 16px; }
        .modal-content button { margin-top: 20px; padding: 12px 24px; border: none; border-radius: 8px; background: var(--primary); color: #fff; font-size: 1rem; cursor: pointer; }
        .modal-content button:hover { background: var(--primary-light); }
        .clock-button {
            margin-left: 12px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .clock-button svg { display: block; }
        .popover-access {
            position: absolute;
            top: 120%;
            right: 0;
            min-width: 260px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            padding: 20px 18px 12px 18px;
            z-index: 1002;
            font-size: 1rem;
            color: var(--text);
            animation: fadeIn 0.25s;
        }
        .popover-access .access-main {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.08rem;
            margin-bottom: 8px;
        }
        .popover-access .access-sticker {
            font-size: 1.5rem;
        }
        .popover-access .access-dates {
            font-size: 0.92rem;
            color: var(--text-light);
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .popover-access .access-calendar {
            font-size: 1.1rem;
        }
        .popover-access .access-close {
            position: absolute;
            top: 8px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--text-light);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="loader" id="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="modal" class="modal" style="display:none;">
        <div class="modal-content" id="modal-content"></div>
    </div>
    <div class="header">
        <a href="index.html" class="back-button">
            <svg viewBox="0 0 24 24">
                <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
            </svg>
        </a>
        <div class="header-title">AI eggo
            <button class="clock-button" id="access-widget-btn" onclick="toggleAccessPopover(event)" title="–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å?">
                <svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#FFA500"/><path d="M12 7v5l4 2" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
        </div>
        <div id="access-popover" class="popover-access" style="display:none;"></div>
    </div>
    <div class="chat-container" id="chat-container" style="display:none;">
        <div class="chat-messages" id="chat-output"></div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button id="send-button" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
    <script>
        // === –ù–ê–°–¢–†–û–ô–ö–ò FIREBASE ===
        // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π URL Firebase Realtime Database
        const FIREBASE_URL = 'https://vrot-x-7a48f-default-rtdb.firebaseio.com'; // –±–µ–∑ / –Ω–∞ –∫–æ–Ω—Ü–µ
        // –ü—É—Ç—å –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ –ë–î, –Ω–∞–ø—Ä–∏–º–µ—Ä: 'users'
        const USERS_PATH = 'users';

        // === –ü–æ–ª—É—á–µ–Ω–∏–µ Telegram ID –∏–∑ cookie ===
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        function getTelegramId() {
            return getCookie('tg_user_id');
        }

        // === –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firebase ===
        async function fetchUserData(telegramId) {
            const url = `${FIREBASE_URL}/${USERS_PATH}/${telegramId}.json`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î');
            return await res.json();
        }

        // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ ===
        function parseDateDMY(str) {
            // str: '–¥–¥.–º–º.–≥–≥–≥–≥'
            if (!str) return null;
            const [day, month, year] = str.split('.').map(Number);
            return new Date(year, month - 1, day);
        }
        function daysLeft(dateExpired) {
            const today = new Date();
            today.setHours(0,0,0,0);
            dateExpired = new Date(dateExpired);
            dateExpired.setHours(0,0,0,0);
            return Math.max(0, Math.ceil((dateExpired - today) / (24*60*60*1000)));
        }
        function isAccessAllowed(user) {
            if (!user) return { allowed: false, reason: 'not_found' };
            if (user.oplata !== 1) return { allowed: false, reason: 'no_payment' };
            const dateOplata = parseDateDMY(user.date_oplata);
            if (!dateOplata) return { allowed: false, reason: 'date_error' };
            // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞: –¥–µ–Ω—å –æ–ø–ª–∞—Ç—ã + 1 –¥–µ–Ω—å
            const dateExpired = new Date(dateOplata);
            dateExpired.setDate(dateExpired.getDate() + 1); // 2 –¥–Ω—è: –¥–µ–Ω—å –æ–ø–ª–∞—Ç—ã –∏ —Å–ª–µ–¥—É—é—â–∏–π
            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É (–±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏)
            const today = new Date();
            today.setHours(0,0,0,0);
            dateExpired.setHours(0,0,0,0);
            if (today <= dateExpired) {
                return { allowed: true, dateExpired };
            } else {
                return { allowed: false, reason: 'expired', dateExpired };
            }
        }

        // === UI —Ñ—É–Ω–∫—Ü–∏–∏ ===
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }
        function showModal(html) {
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';
        }
        function hideModal() {
            document.getElementById('modal').style.display = 'none';
        }
        function showChat() {
            document.getElementById('chat-container').style.display = 'flex';
        }
        function showAccessDaysLeft(dateExpired) {
            const left = daysLeft(dateExpired);
            showModal(`<h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2><p>–î–æ—Å—Ç—É–ø –∫ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –¥–æ—Å—Ç—É–ø–µ–Ω –µ—â–µ <b>${left}</b> ${left === 1 ? '–¥–µ–Ω—å' : (left >= 2 && left <= 4 ? '–¥–Ω—è' : '–¥–Ω–µ–π')}.</p><button onclick=\"hideModal()\">–û–∫</button>`);
        }

        // === –õ–æ–≥–∏–∫–∞ —Å—Ç–∞—Ä—Ç–∞ ===
        let currentUser = null;
        let accessCheckInterval = null;
        async function checkAccessAndUpdateUI() {
            if (!currentUser) return;
            const access = isAccessAllowed(currentUser);
            if (access.allowed) {
                showChat();
                hideModal();
            } else if (access.reason === 'expired') {
                document.getElementById('chat-container').style.display = 'none';
                const dateExpiredStr = access.dateExpired ? access.dateExpired.toLocaleDateString('ru-RU', { timeZone: 'Europe/Moscow' }) : '';
                showModal(`
                    <h2>–°—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–∞ –∏—Å—Ç—ë–∫</h2>
                    <p>–î–æ—Å—Ç—É–ø –∫ –ò–ò –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ 2 –¥–Ω—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã.<br>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç—ë–∫: <b>${dateExpiredStr}</b></p>
                    <button onclick=\"window.location.href='index.html'\">–í –º–µ–Ω—é</button>
                `);
            }
        }
        async function init() {
            showLoader(true);
            try {
                const telegramId = getTelegramId();
                if (!telegramId) {
                    showLoader(false);
                    showModal(`
                        <h2>–û—à–∏–±–∫–∞</h2>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à Telegram ID.<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ Telegram Mini App.</p>
                        <button onclick="window.location.href='index.html'">–í –º–µ–Ω—é</button>
                    `);
                    return;
                }
                const user = await fetchUserData(telegramId);
                currentUser = user;
                const access = isAccessAllowed(user);
                showLoader(false);
                if (!user || access.reason === 'not_found' || access.reason === 'no_payment') {
                    showModal(`
                        <h2>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h2>
                        <p>–ò–ò –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ –ø–æ–ª–Ω–æ–º –∫—É—Ä—Å–µ.<br>–û—Ñ–æ—Ä–º–∏—Ç–µ –æ–ø–ª–∞—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.</p>
                        <button onclick=\"window.location.href='oplata.html'\">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</button>
                    `);
                } else if (access.reason === 'expired') {
                    const dateExpiredStr = access.dateExpired ? access.dateExpired.toLocaleDateString('ru-RU', { timeZone: 'Europe/Moscow' }) : '';
                    showModal(`
                        <h2>–°—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–∞ –∏—Å—Ç—ë–∫</h2>
                        <p>–î–æ—Å—Ç—É–ø –∫ –ò–ò –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ 2 –¥–Ω—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã.<br>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç—ë–∫: <b>${dateExpiredStr}</b></p>
                        <button onclick=\"window.location.href='index.html'\">–í –º–µ–Ω—é</button>
                    `);
                } else if (access.allowed) {
                    showChat();
                    if (accessCheckInterval) clearInterval(accessCheckInterval);
                    accessCheckInterval = setInterval(checkAccessAndUpdateUI, 5000); // 5 —Å–µ–∫—É–Ω–¥
                }
            } catch (e) {
                showLoader(false);
                showModal(`
                    <h2>–û—à–∏–±–∫–∞</h2>
                    <p>${e.message}</p>
                    <button onclick=\"window.location.reload()\">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                `);
            }
        }
        window.addEventListener('DOMContentLoaded', init);

        // === –í–∞—à –∫–æ–¥ —á–∞—Ç–∞ (—Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏) ===
        const API_ENDPOINT = 'https://openai-proxy.egorspirin10.workers.dev/';
        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        function addMessage(text, isUser, isTyping) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            if (isUser) messageDiv.classList.add('fade-in-slide');
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? '' : 'bot-avatar'}`;
            avatar.textContent = isUser ? '–Ø' : 'AI';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            if (!isUser && isTyping) {
                contentDiv.className = 'typing-indicator';
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'typing-dot';
                    contentDiv.appendChild(dot);
                }
            } else {
                contentDiv.textContent = text;
            }
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatOutput.appendChild(messageDiv);
            chatOutput.scrollTop = chatOutput.scrollHeight;
            return contentDiv;
        }
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            userInput.value = '';
            sendButton.disabled = true;
            addMessage(message, true, false);
            // –ü–ª–∞–≤–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è
            await new Promise(r => setTimeout(r, 250));
            const typingIndicator = addMessage('', false, true);
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                const data = await response.json();
                typingIndicator.className = 'message-content';
                typingIndicator.textContent = data.reply;
            } catch (error) {
                typingIndicator.className = 'message-content';
                typingIndicator.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
            } finally {
                sendButton.disabled = false;
                chatOutput.scrollTop = chatOutput.scrollHeight;
                userInput.focus();
            }
        }
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        userInput.focus();

        function formatDateDMY(date) {
            return date.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' });
        }
        function toggleAccessPopover(e) {
            if (!currentUser) return;
            const access = isAccessAllowed(currentUser);
            const popover = document.getElementById('access-popover');
            if (popover.style.display === 'block') {
                popover.style.display = 'none';
                return;
            }
            // –î–∞—Ç—ã –¥–æ—Å—Ç—É–ø–∞
            const dateOplata = parseDateDMY(currentUser.date_oplata);
            const dateStart = new Date(dateOplata);
            const dateEnd = new Date(dateOplata);
            dateEnd.setDate(dateEnd.getDate() + 1);
            dateStart.setHours(0,0,0,0);
            dateEnd.setHours(0,0,0,0);
            const today = new Date();
            today.setHours(0,0,0,0);
            let mainText = '';
            let sticker = '';
            if (today.getTime() === dateEnd.getTime()) {
                mainText = '–ò–ò-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–µ–Ω <b>–ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å</b>';
                sticker = '‚è≥';
            } else {
                const left = daysLeft(dateEnd);
                mainText = `–ò–ò-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –µ—â–µ <b>${left}</b> ${left === 1 ? '–¥–µ–Ω—å' : (left >= 2 && left <= 4 ? '–¥–Ω—è' : '–¥–Ω–µ–π')}`;
                sticker = left > 1 ? 'üïí' : '‚è≥';
            }
            popover.innerHTML = `
                <button class='access-close' onclick='document.getElementById("access-popover").style.display="none"'>&times;</button>
                <div class='access-main'><span class='access-sticker'>${sticker}</span> <span>${mainText}</span></div>
                <div class='access-dates'><span class='access-calendar'>üìÖ</span> <span>—Å <b>${formatDateDMY(dateStart)}</b> –ø–æ <b>${formatDateDMY(dateEnd)}</b> –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ</span></div>
            `;
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º popover –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π
            popover.style.display = 'block';
            const btn = document.getElementById('access-widget-btn');
            const rect = btn.getBoundingClientRect();
            popover.style.top = (btn.offsetTop + btn.offsetHeight + 6) + 'px';
            popover.style.right = (window.innerWidth - rect.right + 8) + 'px';
        }
    </script>
</body>
</html>
