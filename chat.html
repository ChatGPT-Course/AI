

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI eggo</title>
    <style>
        /* ... ваш CSS без изменений ... */
        /* Добавим стили для loader и модальных окон */
        .loader {
            position: fixed;
            z-index: 1000;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--primary);
        }
        .modal {
            position: fixed;
            z-index: 1001;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            padding: 32px 24px;
            border-radius: 16px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.12);
            text-align: center;
            max-width: 90vw;
        }
        .modal-content h2 {
            margin-bottom: 16px;
        }
        .modal-content button {
            margin-top: 20px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
        }
        .modal-content button:hover {
            background: var(--primary-light);
        }
    </style>
</head>
<body>
    <div class="loader" id="loader">Загрузка...</div>
    <div id="modal" class="modal" style="display:none;">
        <div class="modal-content" id="modal-content"></div>
    </div>
    <div class="header">
        <a href="index.html" class="back-button">
            <svg viewBox="0 0 24 24">
                <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
            </svg>
        </a>
        <div class="header-title">AI eggo</div>
    </div>
    <div class="chat-container" id="chat-container" style="display:none;">
        <div class="chat-messages" id="chat-output"></div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Напишите сообщение..." autocomplete="off">
            <button id="send-button" onclick="sendMessage()">Отправить</button>
        </div>
    </div>
    <script>
        // === НАСТРОЙКИ FIREBASE ===
        // Замените на свой URL Firebase Realtime Database
        const FIREBASE_URL = 'https://ВАШ-PROJECT.firebaseio.com'; // без / на конце
        // Путь к пользователям в БД, например: 'users'
        const USERS_PATH = 'users';

        // === Получение Telegram ID ===
        function getTelegramId() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                return window.Telegram.WebApp.initDataUnsafe.user.id;
            }
            // Для теста на ПК можно временно вернуть тестовый ID
            // return '123456789';
            return null;
        }

        // === Получение данных пользователя из Firebase ===
        async function fetchUserData(telegramId) {
            // Пример: https://your-project.firebaseio.com/users/123456789.json
            const url = `${FIREBASE_URL}/${USERS_PATH}/${telegramId}.json`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Ошибка доступа к БД');
            return await res.json();
        }

        // === Проверка доступа ===
        function isAccessAllowed(user) {
            if (!user) return { allowed: false, reason: 'not_found' };
            if (user.oplata !== 1) return { allowed: false, reason: 'no_payment' };
            // Даты в формате ISO или timestamp
            const now = new Date();
            // Преобразуем к Date
            const dateOplata = new Date(user.date_oplata);
            const dateExpired = new Date(user.date_expired);
            // Переводим текущее время в МСК (UTC+3)
            const nowMsk = new Date(now.getTime() + (3 - now.getTimezoneOffset()/60)*60*60*1000);
            if (nowMsk >= dateOplata && nowMsk <= dateExpired) {
                return { allowed: true };
            } else {
                return { allowed: false, reason: 'expired', dateExpired };
            }
        }

        // === UI функции ===
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }
        function showModal(html) {
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal').style.display = 'flex';
        }
        function hideModal() {
            document.getElementById('modal').style.display = 'none';
        }
        function showChat() {
            document.getElementById('chat-container').style.display = 'flex';
        }

        // === Логика старта ===
        async function init() {
            showLoader(true);
            try {
                const telegramId = getTelegramId();
                if (!telegramId) {
                    showLoader(false);
                    showModal(`
                        <h2>Ошибка</h2>
                        <p>Не удалось получить ваш Telegram ID.<br>Пожалуйста, откройте сайт через Telegram Mini App.</p>
                        <button onclick="window.location.href='index.html'">В меню</button>
                    `);
                    return;
                }
                const user = await fetchUserData(telegramId);
                const access = isAccessAllowed(user);

                showLoader(false);

                if (!user || access.reason === 'not_found') {
                    showModal(`
                        <h2>Нет доступа</h2>
                        <p>Данные о вашей оплате не найдены.<br>ИИ доступен только в полном курсе.</p>
                        <button onclick="window.location.href='oplata.html'">Перейти к оплате</button>
                    `);
                } else if (access.reason === 'no_payment') {
                    showModal(`
                        <h2>Доступ ограничен</h2>
                        <p>ИИ доступен только в полном курсе.<br>Оформите оплату для получения доступа.</p>
                        <button onclick="window.location.href='oplata.html'">Перейти к оплате</button>
                    `);
                } else if (access.reason === 'expired') {
                    showModal(`
                        <h2>Срок доступа истёк</h2>
                        <p>ИИ был доступен в течение 30 дней после покупки курса.<br>Срок действия истёк: <b>${access.dateExpired.toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })}</b></p>
                        <button onclick="window.location.href='index.html'">В меню</button>
                    `);
                } else if (access.allowed) {
                    showChat();
                }
            } catch (e) {
                showLoader(false);
                showModal(`
                    <h2>Ошибка</h2>
                    <p>${e.message}</p>
                    <button onclick="window.location.reload()">Повторить</button>
                `);
            }
        }

        // === Запуск ===
        window.addEventListener('DOMContentLoaded', init);

        // === Ваш код чата (без изменений) ===
        const API_ENDPOINT = 'https://openai-proxy.egorspirin10.workers.dev/';
        const chatOutput = document.getElementById('chat-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        function addMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            const avatar = document.createElement('div');
            avatar.className = `avatar ${isUser ? '' : 'bot-avatar'}`;
            avatar.textContent = isUser ? 'Я' : 'AI';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            if (!isUser && text === 'typing') {
                contentDiv.className = 'typing-indicator';
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'typing-dot';
                    contentDiv.appendChild(dot);
                }
            } else {
                contentDiv.textContent = text;
            }
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatOutput.appendChild(messageDiv);
            chatOutput.scrollTop = chatOutput.scrollHeight;
            return contentDiv;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            userInput.value = '';
            sendButton.disabled = true;
            addMessage(message, true);
            const typingIndicator = addMessage('typing', false);
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                if (!response.ok) throw new Error('Ошибка сервера');
                const data = await response.json();
                typingIndicator.className = 'message-content';
                typingIndicator.textContent = data.reply;
            } catch (error) {
                typingIndicator.className = 'message-content';
                typingIndicator.textContent = `Ошибка: ${error.message}`;
            } finally {
                sendButton.disabled = false;
                chatOutput.scrollTop = chatOutput.scrollHeight;
                userInput.focus();
            }
        }
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        userInput.focus();
    </script>
</body>
</html>
