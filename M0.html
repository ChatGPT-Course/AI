<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>NocoDB Редактор</title>
    <script src="https://cdn.jsdelivr.net/npm/@nocodb/sdk/dist/nocodb-sdk.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        button { padding: 10px 15px; margin: 5px; background: #4285f4; color: white; border: none; border-radius: 4px; }
        #status { margin-top: 20px; padding: 10px; border-radius: 4px; }
        .success { background: #e6f4ea; color: #0d652d; }
        .error { background: #fce8e6; color: #d93025; }
    </style>
</head>
<body>
    <h2>Обновление данных</h2>
    <button id="introBtn">Установить ИНТРО (1)</button>
    <button id="moBtn">Установить М0 (2)</button>
    <div id="status">Ожидание действий...</div>

    <script>
        // Инициализация NocoDB SDK
        const nocoDB = new NocoDB({
            baseURL: 'https://app.nocodb.com',
            dbToken: 'bocQfycJpJsTG_tbwEf8ma8E5rhoig0njMDXFWtJ' // Получите новый токен!
        });

        // Получаем user_id из cookie
        function getUserId() {
            const match = document.cookie.match(/tg_user_id=([^;]+)/);
            return match ? match[1] : null;
        }

        // Обновляем статус
        function updateStatus(message, isSuccess = true) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isSuccess ? 'success' : 'error';
        }

        // Основная функция обновления с fallback
        async function updateColumn(columnName, value) {
            const userId = getUserId();
            if (!userId) {
                updateStatus('Ошибка: ID пользователя не найден', false);
                return;
            }

            try {
                // 1. Поиск записи через SDK
                const { list } = await nocoDB.dbTableRow.list(
                    'mc6qh91f060pv4y', 
                    {
                        where: `(tg_user_id,eq,${userId})`
                    }
                );

                if (!list.length) throw new Error('Запись не найдена');

                // 2. Попытка обновления через SDK
                try {
                    await nocoDB.dbTableRow.update(
                        'mc6qh91f060pv4y',
                        list[0].Id,
                        { [columnName]: value }
                    );
                    updateStatus(`Успешно обновлено: ${columnName} = ${value}`);
                } catch (updateError) {
                    // 3. Fallback: создание новой записи
                    await nocoDB.dbTableRow.create(
                        'mc6qh91f060pv4y',
                        {
                            ...list[0],
                            [columnName]: value,
                            Id: undefined // Сброс ID для новой записи
                        }
                    );
                    updateStatus(`Создана новая запись с ${columnName} = ${value}`);
                }

            } catch (error) {
                console.error('Ошибка:', error);
                updateStatus(`Ошибка: ${error.message}`, false);
            }
        }

        // Назначение обработчиков
        document.getElementById('introBtn').addEventListener('click', () => updateColumn('intro', '1'));
        document.getElementById('moBtn').addEventListener('click', () => updateColumn('Mo', '2'));

        // Проверка при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            if (!getUserId()) {
                updateStatus('Внимание: tg_user_id не найден в cookie', false);
            }
        });
    </script>
</body>
</html>
