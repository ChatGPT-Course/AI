<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Обновление данных</title>
    <style>
        body { font-family: Arial, padding: 20px; text-align: center; }
        button { padding: 12px 24px; margin: 10px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #status { margin-top: 20px; padding: 10px; }
        .success { background: #e6ffed; color: #006400; }
        .error { background: #ffebee; color: #d32f2f; }
    </style>
</head>
<body>
    <h2>Выберите действие:</h2>
    <button id="introBtn">ИНТРО (1)</button>
    <button id="moBtn">М0 (2)</button>
    <div id="status">Ожидание действий...</div>

    <script>
        // КОНФИГУРАЦИЯ (ЗАМЕНИТЕ!)
        const config = {
            apiUrl: 'https://app.nocodb.com/api/v2/tables/mc6qh91f060pv4y/records',
            apiToken: 'bocQfycJpJsTG_tbwEf8ma8E5rhoig0njMDXFWtJ' // Получите на https://app.nocodb.com/#/account/tokens
        };

        // Получаем user_id из cookie
        function getUserId() {
            const cookie = document.cookie.match(/tg_user_id=([^;]+)/);
            return cookie ? cookie[1] : null;
        }

        // Обновляем статус
        function updateStatus(message, isSuccess = true) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isSuccess ? 'success' : 'error';
        }

        // Основная функция обновления
        async function updateColumn(columnName, value) {
            const userId = getUserId();
            if (!userId) {
                updateStatus('Ошибка: tg_user_id не найден в cookie', false);
                return;
            }

            try {
                // 1. Ищем запись пользователя
                const searchUrl = `${config.apiUrl}?where=(tg_user_id,eq,${userId})`;
                const searchRes = await fetch(searchUrl, {
                    headers: { 'xc-token': config.apiToken }
                });

                if (!searchRes.ok) throw new Error(`Ошибка поиска: ${searchRes.status}`);
                
                const { list } = await searchRes.json();
                if (!list?.length) throw new Error('Пользователь не найден');

                // 2. Обновляем запись
                const updateUrl = `${config.apiUrl}/${list[0].Id}`;
                const updateRes = await fetch(updateUrl, {
                    method: 'PATCH', // Важно: используем PATCH для обновления
                    headers: {
                        'Content-Type': 'application/json',
                        'xc-token': config.apiToken
                    },
                    body: JSON.stringify({ [columnName]: value })
                });

                if (!updateRes.ok) {
                    const errorDetails = await updateRes.json().catch(() => ({}));
                    throw new Error(errorDetails.message || `Ошибка ${updateRes.status}`);
                }

                updateStatus(`Успешно! ${columnName} = ${value}`);
            } catch (error) {
                console.error('Ошибка:', error);
                updateStatus(`Ошибка: ${error.message}`, false);
            }
        }

        // Назначаем обработчики
        document.getElementById('introBtn').onclick = () => updateColumn('intro', '1');
        document.getElementById('moBtn').onclick = () => updateColumn('Mo', '2');
    </script>
</body>
</html>
