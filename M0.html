<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>NocoDB Update</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        button { padding: 12px 24px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; }
        #status { margin-top: 20px; padding: 15px; border-radius: 6px; background: #f1f3f4; }
        .success { color: #0d652d; }
        .error { color: #d93025; }
    </style>
</head>
<body>
    <h2>Обновление данных</h2>
    <button id="updateBtn">Обновить Progress</button>
    <div id="status">Ожидание действий...</div>

    <script>
        // Конфигурация (ЗАМЕНИТЕ НА СВОИ ДАННЫЕ)
        const config = {
            orgs: 'weamcfo6',          // Из URL: https://app.nocodb.com/#/weamcfo6/...
            projectName: 'p27jdsmk69wuimh', // Из URL
            tableName: 'mc6qh91f060pv4y',   // Из URL
            apiToken: 'bocQfycJpJsTG_tbwEf8ma8E5rhoig0njMDXFWtJ'  // Из Settings → API Tokens
        };

        const statusEl = document.getElementById('status');

        // Получаем ID пользователя из cookie
        function getUserId() {
            const match = document.cookie.match(/tg_user_id=([^;]+)/);
            return match ? match[1] : null;
        }

        // Обновляем статус
        function updateStatus(message, isSuccess = true) {
            statusEl.innerHTML = `${isSuccess ? '✅' : '❌'} ${message}`;
            statusEl.className = isSuccess ? 'success' : 'error';
        }

        // Основная функция обновления
        async function updateProgress() {
            const userId = getUserId();
            if (!userId) {
                updateStatus('Ошибка: ID пользователя не найден', false);
                return;
            }

            try {
                updateStatus('Поиск записи пользователя...');
                
                // 1. Находим запись пользователя
                const searchUrl = `https://app.nocodb.com/api/v1/db/data/${config.orgs}/${config.projectName}/${config.tableName}?where=(tg_user_id,eq,${userId})`;
                const searchRes = await fetch(searchUrl, {
                    headers: { 'xc-token': config.apiToken }
                });
                
                if (!searchRes.ok) throw new Error(`Ошибка поиска: ${searchRes.status}`);
                
                const { list } = await searchRes.json();
                if (!list?.length) throw new Error('Запись не найдена');
                
                const record = list[0];
                const newProgress = (record.progress || 0) + 1;
                
                updateStatus(`Найдена запись ID ${record.Id}. Обновляем progress на ${newProgress}`);

                // 2. Обновляем запись по официальному API
                const updateUrl = `https://app.nocodb.com/api/v1/db/data/${config.orgs}/${config.projectName}/${config.tableName}/${record.Id}`;
                const updateRes = await fetch(updateUrl, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'xc-token': config.apiToken
                    },
                    body: JSON.stringify({ progress: newProgress })
                });
                
                if (!updateRes.ok) {
                    const errorDetails = await updateRes.json().catch(() => ({}));
                    throw new Error(errorDetails.message || `Ошибка ${updateRes.status}`);
                }

                const result = await updateRes.json();
                updateStatus(`Успешно! Новый progress: ${result.progress}`);

            } catch (error) {
                console.error('Ошибка:', error);
                updateStatus(`ОШИБКА: ${error.message}`, false);
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            const userId = getUserId();
            if (userId) {
                document.getElementById('updateBtn').addEventListener('click', updateProgress);
                updateStatus(`Готово. ID пользователя: ${userId}`);
            } else {
                updateStatus('Ошибка: tg_user_id не найден в cookie', false);
            }
        });
    </script>
</body>
</html>
