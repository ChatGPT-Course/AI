<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>NocoDB Record Updater</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        button { 
            padding: 12px 24px; 
            background: #4285f4; 
            color: white; 
            border: none; 
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            background: #f1f3f4;
        }
        .success { color: #0d652d; }
        .error { color: #d93025; }
    </style>
</head>
<body>
    <h2>Обновление прогресса</h2>
    <button id="updateBtn">Увеличить Progress +1</button>
    <div id="status">Готов к работе. ID пользователя: <span id="userId"></span></div>

    <script>
        // Конфигурация (ЗАМЕНИТЕ НА СВОИ!)
        const config = {
            apiUrl: 'https://app.nocodb.com/api/v2/tables/mc6qh91f060pv4y/records',
            apiToken: 'bocQfycJpJsTG_tbwEf8ma8E5rhoig0njMDXFWtJ'
        };

        // Элементы интерфейса
        const updateBtn = document.getElementById('updateBtn');
        const statusEl = document.getElementById('status');
        const userIdEl = document.getElementById('userId');

        // Получаем ID пользователя из cookie
        function getUserId() {
            const match = document.cookie.match(/tg_user_id=([^;]+)/);
            return match ? match[1] : null;
        }

        // Логирование статуса
        function updateStatus(message, isSuccess = true) {
            statusEl.innerHTML = `${isSuccess ? '✅' : '❌'} ${message}`;
            statusEl.className = isSuccess ? 'success' : 'error';
        }

        // Основная функция обновления
        async function incrementProgress() {
            const userId = getUserId();
            if (!userId) {
                updateStatus('Ошибка: ID пользователя не найден', false);
                return;
            }

            try {
                updateStatus('Поиск записи пользователя...');
                
                // 1. Находим текущую запись
                const searchRes = await fetch(`${config.apiUrl}?where=(tg_user_id,eq,${userId})`, {
                    headers: { 'xc-token': config.apiToken }
                });
                
                if (!searchRes.ok) throw new Error(`Ошибка поиска: ${searchRes.status}`);
                
                const { list } = await searchRes.json();
                if (!list?.length) throw new Error('Запись не найдена');
                
                const oldRecord = list[0];
                const newProgress = (oldRecord.progress || 0) + 1;
                
                updateStatus(`Найдена запись ID ${oldRecord.Id}. Progress будет ${newProgress}`);

                // 2. Удаляем старую запись
                updateStatus('Удаление старой записи...');
                const deleteRes = await fetch(`${config.apiUrl}/${oldRecord.Id}`, {
                    method: 'DELETE',
                    headers: { 'xc-token': config.apiToken }
                });
                
                if (!deleteRes.ok) throw new Error(`Ошибка удаления: ${deleteRes.status}`);

                // 3. Создаём новую запись
                updateStatus('Создание новой записи...');
                const newRecord = {
                    ...oldRecord,
                    progress: newProgress,
                    Id: undefined // Важно: убираем ID для новой записи
                };
                
                const createRes = await fetch(config.apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'xc-token': config.apiToken 
                    },
                    body: JSON.stringify(newRecord)
                });
                
                if (!createRes.ok) throw new Error(`Ошибка создания: ${createRes.status}`);
                
                const result = await createRes.json();
                updateStatus(`Успешно! Новый Progress: ${result.progress}. ID новой записи: ${result.Id}`);

            } catch (error) {
                console.error('Ошибка:', error);
                updateStatus(`ОШИБКА: ${error.message}`, false);
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            const userId = getUserId();
            if (userId) {
                userIdEl.textContent = userId;
                updateBtn.addEventListener('click', incrementProgress);
            } else {
                updateStatus('Ошибка: tg_user_id не найден в cookie', false);
            }
        });
    </script>
</body>
</html>
